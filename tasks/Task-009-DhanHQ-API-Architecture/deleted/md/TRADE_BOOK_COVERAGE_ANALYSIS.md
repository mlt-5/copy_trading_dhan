# Trade Book API - Coverage Analysis

Complete analysis of DhanHQ v2 Trade Book API coverage in Task 9.

**API Endpoint**: `GET /trades` and `GET /trades/{order-id}`

**Reference**: https://dhanhq.co/docs/v2/orders/

---

## API Response Fields (17 Total)

According to DhanHQ documentation:

| # | Field | Type | Description |
|---|-------|------|-------------|
| 1 | dhanClientId | string | User specific identification generated by Dhan |
| 2 | orderId | string | Order specific identification generated by Dhan |
| 3 | exchangeOrderId | string | Order specific identification generated by exchange |
| 4 | exchangeTradeId | string | Trade specific identification generated by exchange |
| 5 | transactionType | enum string | The trading side of transaction (BUY/SELL) |
| 6 | exchangeSegment | enum string | Exchange Segment |
| 7 | productType | enum string | Product type (CNC/INTRADAY/MARGIN/MTF/CO/BO) |
| 8 | orderType | enum string | Order Type (LIMIT/MARKET/STOP_LOSS/STOP_LOSS_MARKET) |
| 9 | tradingSymbol | string | Trading Symbol |
| 10 | securityId | string | Exchange standard ID |
| 11 | tradedQuantity | int | Number of shares executed |
| 12 | tradedPrice | float | Price at which trade is executed |
| 13 | createTime | string | Time at which the order is created |
| 14 | updateTime | string | Time at which the last activity happened |
| 15 | exchangeTime | string | Time at which order reached at exchange |
| 16 | drvExpiryDate | int | For F&O, expiry date of contract |
| 17 | drvOptionType | enum string | Type of Option (CALL/PUT) |
| 18 | drvStrikePrice | float | For Options, Strike Price |

**Total**: 18 fields (includes 17 data fields + timestamps)

---

## Current Implementation Status

### 1. API Wrapper ✅

**File**: `src/dhan_api/orders.py`
**Method**: `get_trade_history()` (lines 480-510)

```python
def get_trade_history(self, order_id: Optional[str] = None) -> Optional[List[Dict[str, Any]]]:
    """
    Get trade history (filled orders).
    
    Args:
        order_id: Optional order ID to filter trades
    
    Returns:
        List of trade dicts, or None if failed
    """
    try:
        if order_id:
            response = self.client.get_trade_book(order_id)  # GET /trades/{order-id}
        else:
            response = self.client.get_trade_book()          # GET /trades
        
        if response and isinstance(response, list):
            return response
        else:
            return []
    
    except Exception as e:
        logger.error("Get trade history error", exc_info=True)
        return None
```

**Status**: ✅ Both endpoints implemented
- GET /trades (all trades for the day)
- GET /trades/{order-id} (trades for specific order)

---

### 2. Trade Model ❌ INCOMPLETE

**File**: `src/core/models.py`
**Current**: 9 fields only (lines 142-166)

```python
@dataclass
class Trade:
    """Represents a trade execution."""
    id: str
    order_id: str
    account_type: Literal['leader', 'follower']
    trade_ts: int
    quantity: int
    price: float
    exchange_segment: Optional[str] = None
    security_id: Optional[str] = None
    raw_data: Optional[str] = None
```

**Missing Fields** (9/18):
- ❌ exchange_order_id (exchangeOrderId)
- ❌ exchange_trade_id (exchangeTradeId)
- ❌ transaction_type (transactionType: BUY/SELL)
- ❌ product_type (productType)
- ❌ order_type (orderType)
- ❌ trading_symbol (tradingSymbol)
- ❌ created_at (createTime)
- ❌ updated_at (updateTime)
- ❌ exchange_time (exchangeTime)
- ❌ drv_expiry_date (drvExpiryDate)
- ❌ drv_option_type (drvOptionType: CALL/PUT)
- ❌ drv_strike_price (drvStrikePrice)

**Coverage**: 6/18 fields = **33% Complete** ❌

---

### 3. Database Schema ⚠️ PARTIAL

**File**: `src/core/database/schema_v3_comprehensive.sql`
**Table**: `trades` (lines 580-622)

```sql
CREATE TABLE IF NOT EXISTS trades (
    id TEXT PRIMARY KEY,                   -- Trade ID ✅
    order_id TEXT NOT NULL,                -- orderId ✅
    account_type TEXT NOT NULL,            -- Internal (leader/follower) ✅
    
    -- Trade details
    exchange_order_id TEXT,                -- exchangeOrderId ✅
    exchange_trade_id TEXT,                -- exchangeTradeId ✅
    security_id TEXT NOT NULL,             -- securityId ✅
    exchange_segment TEXT NOT NULL,        -- exchangeSegment ✅
    trading_symbol TEXT,                   -- tradingSymbol ✅
    
    -- Transaction details
    side TEXT NOT NULL,                    -- transactionType ✅
    product TEXT NOT NULL,                 -- productType ✅
    
    -- Quantity and pricing
    quantity INTEGER NOT NULL,             -- tradedQuantity ✅
    price REAL NOT NULL,                   -- tradedPrice ✅
    trade_value REAL,                      -- Calculated
    
    -- Charges (not in API response)
    brokerage REAL DEFAULT 0,
    exchange_charges REAL DEFAULT 0,
    clearing_charges REAL DEFAULT 0,
    stt REAL DEFAULT 0,
    stamp_duty REAL DEFAULT 0,
    transaction_charges REAL DEFAULT 0,
    gst REAL DEFAULT 0,
    total_charges REAL DEFAULT 0,
    net_amount REAL,
    
    -- Timestamps
    trade_ts INTEGER NOT NULL,             -- Trade timestamp ✅
    created_at INTEGER NOT NULL,           -- createTime ✅
    
    -- Raw data
    raw_data TEXT,                         -- JSON ✅
    
    CHECK (account_type IN ('leader', 'follower')),
    CHECK (side IN ('BUY', 'SELL')),
    FOREIGN KEY(order_id) REFERENCES orders(id) ON DELETE CASCADE
);
```

**Missing Fields** (5/18):
- ❌ order_type (orderType: LIMIT/MARKET/STOP_LOSS/STOP_LOSS_MARKET)
- ❌ updated_at (updateTime)
- ❌ exchange_time (exchangeTime)
- ❌ drv_expiry_date (drvExpiryDate)
- ❌ drv_option_type (drvOptionType: CALL/PUT)
- ❌ drv_strike_price (drvStrikePrice)

**Coverage**: 13/18 fields = **72% Complete** ⚠️

---

### 4. Database Methods ❌ MISSING

**File**: `src/core/database.py`

**Status**: NO methods to save or retrieve trades

Missing methods:
- ❌ `save_trade(trade: Trade) -> None`
- ❌ `get_trades(account_type: str, ...) -> List[Trade]`
- ❌ `get_trade_by_id(trade_id: str) -> Optional[Trade]`
- ❌ `get_trades_by_order_id(order_id: str) -> List[Trade]`

**Coverage**: 0/4 methods = **0% Complete** ❌

---

## Gap Summary

| Component | Status | Coverage | Critical Issues |
|-----------|--------|----------|-----------------|
| **API Wrapper** | ✅ Complete | 100% | None |
| **Trade Model** | ❌ Incomplete | 33% (6/18) | Missing 12 fields |
| **Database Schema** | ⚠️ Partial | 72% (13/18) | Missing 5 F&O & timestamp fields |
| **Database Methods** | ❌ Missing | 0% | No save/retrieve methods |

---

## Required Fixes

### Fix 1: Update Trade Model (12 missing fields)

**File**: `src/core/models.py`

Add missing fields to Trade dataclass:
```python
@dataclass
class Trade:
    """Represents a trade execution."""
    # Primary identification
    id: str                                        # Trade ID or exchange_trade_id
    order_id: str                                  # orderId ✅
    account_type: Literal['leader', 'follower']    # Internal ✅
    
    # Exchange identifiers
    exchange_order_id: Optional[str] = None        # exchangeOrderId ✅
    exchange_trade_id: Optional[str] = None        # exchangeTradeId ✅
    
    # Instrument details
    security_id: str                               # securityId ✅
    exchange_segment: str                          # exchangeSegment ✅
    trading_symbol: Optional[str] = None           # tradingSymbol ✅
    
    # Transaction details
    transaction_type: str                          # transactionType (BUY/SELL) ✅
    product_type: str                              # productType ✅
    order_type: str                                # orderType ❌ NEW
    
    # Quantity and pricing
    quantity: int                                  # tradedQuantity (traded_qty) ✅
    price: float                                   # tradedPrice ✅
    
    # Timestamps
    trade_ts: int                                  # Trade timestamp ✅
    created_at: int                                # createTime ✅
    updated_at: Optional[int] = None               # updateTime ❌ NEW
    exchange_time: Optional[int] = None            # exchangeTime ❌ NEW
    
    # F&O derivatives info
    drv_expiry_date: Optional[int] = None          # drvExpiryDate ❌ NEW
    drv_option_type: Optional[str] = None          # drvOptionType (CALL/PUT) ❌ NEW
    drv_strike_price: Optional[float] = None       # drvStrikePrice ❌ NEW
    
    # Raw data
    raw_data: Optional[str] = None                 # JSON ✅
```

**Total**: 18 fields (add 9 new fields)

---

### Fix 2: Update Database Schema (5 missing columns)

**File**: `src/core/database/schema_v3_comprehensive.sql`

Add missing columns to `trades` table:
```sql
ALTER TABLE trades ADD COLUMN order_type TEXT;              -- orderType
ALTER TABLE trades ADD COLUMN updated_at INTEGER;           -- updateTime
ALTER TABLE trades ADD COLUMN exchange_time INTEGER;        -- exchangeTime
ALTER TABLE trades ADD COLUMN drv_expiry_date INTEGER;      -- drvExpiryDate
ALTER TABLE trades ADD COLUMN drv_option_type TEXT;         -- drvOptionType (CALL/PUT)
ALTER TABLE trades ADD COLUMN drv_strike_price REAL;        -- drvStrikePrice

-- Add CHECK constraint for option type
ALTER TABLE trades ADD CONSTRAINT chk_drv_option_type 
    CHECK (drv_option_type IS NULL OR drv_option_type IN ('CALL', 'PUT'));
```

Or in fresh schema definition:
```sql
CREATE TABLE IF NOT EXISTS trades (
    -- ... existing fields ...
    
    -- Transaction details
    side TEXT NOT NULL,                    -- transactionType (BUY/SELL)
    product TEXT NOT NULL,                 -- productType
    order_type TEXT,                       -- orderType ❌ NEW
    
    -- ... quantity and pricing ...
    
    -- Timestamps
    trade_ts INTEGER NOT NULL,             -- Trade timestamp
    created_at INTEGER NOT NULL,           -- createTime
    updated_at INTEGER,                    -- updateTime ❌ NEW
    exchange_time INTEGER,                 -- exchangeTime ❌ NEW
    
    -- F&O derivatives info
    drv_expiry_date INTEGER,               -- drvExpiryDate ❌ NEW
    drv_option_type TEXT,                  -- drvOptionType ❌ NEW
    drv_strike_price REAL,                 -- drvStrikePrice ❌ NEW
    
    -- ... raw data ...
    
    CHECK (drv_option_type IS NULL OR drv_option_type IN ('CALL', 'PUT'))
);
```

---

### Fix 3: Add Database Methods

**File**: `src/core/database.py`

Add trade management methods:
```python
def save_trade(self, trade: Trade) -> None:
    """Save a trade to database."""
    self.conn.execute("""
        INSERT OR REPLACE INTO trades (
            id, order_id, account_type, exchange_order_id, exchange_trade_id,
            security_id, exchange_segment, trading_symbol,
            side, product, order_type,
            quantity, price, trade_value,
            trade_ts, created_at, updated_at, exchange_time,
            drv_expiry_date, drv_option_type, drv_strike_price,
            raw_data
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, (
        trade.id, trade.order_id, trade.account_type,
        trade.exchange_order_id, trade.exchange_trade_id,
        trade.security_id, trade.exchange_segment, trade.trading_symbol,
        trade.transaction_type, trade.product_type, trade.order_type,
        trade.quantity, trade.price, trade.quantity * trade.price,
        trade.trade_ts, trade.created_at, trade.updated_at, trade.exchange_time,
        trade.drv_expiry_date, trade.drv_option_type, trade.drv_strike_price,
        trade.raw_data
    ))
    self.conn.commit()

def get_trades_by_order_id(self, order_id: str) -> List[Trade]:
    """Get all trades for an order."""
    cursor = self.conn.execute("""
        SELECT * FROM trades WHERE order_id = ? ORDER BY trade_ts
    """, (order_id,))
    return [Trade(**dict(row)) for row in cursor.fetchall()]

def get_trades(
    self,
    account_type: Optional[str] = None,
    from_ts: Optional[int] = None,
    to_ts: Optional[int] = None
) -> List[Trade]:
    """Get trades with optional filters."""
    conditions = []
    params = []
    
    if account_type:
        conditions.append("account_type = ?")
        params.append(account_type)
    if from_ts:
        conditions.append("trade_ts >= ?")
        params.append(from_ts)
    if to_ts:
        conditions.append("trade_ts <= ?")
        params.append(to_ts)
    
    where = f"WHERE {' AND '.join(conditions)}" if conditions else ""
    
    cursor = self.conn.execute(f"""
        SELECT * FROM trades {where} ORDER BY trade_ts DESC
    """, params)
    
    return [Trade(**dict(row)) for row in cursor.fetchall()]
```

---

### Fix 4: Update Migration Script

**File**: `src/core/database/migrate_to_v3.sql`

Add ALTER TABLE statements for trades:
```sql
-- Add missing columns to trades table (if exists)
ALTER TABLE trades ADD COLUMN order_type TEXT;
ALTER TABLE trades ADD COLUMN updated_at INTEGER;
ALTER TABLE trades ADD COLUMN exchange_time INTEGER;
ALTER TABLE trades ADD COLUMN drv_expiry_date INTEGER;
ALTER TABLE trades ADD COLUMN drv_option_type TEXT;
ALTER TABLE trades ADD COLUMN drv_strike_price REAL;
```

---

## Field Mapping (API → Model → Schema)

| # | API Field | Model Field | Schema Column | Status |
|---|-----------|-------------|---------------|--------|
| 1 | dhanClientId | account_type | account_type | ✅ |
| 2 | orderId | order_id | order_id | ✅ |
| 3 | exchangeOrderId | exchange_order_id | exchange_order_id | ✅ |
| 4 | exchangeTradeId | exchange_trade_id | exchange_trade_id | ✅ |
| 5 | transactionType | transaction_type | side | ✅ |
| 6 | exchangeSegment | exchange_segment | exchange_segment | ✅ |
| 7 | productType | product_type | product | ✅ |
| 8 | orderType | order_type | order_type | ❌ NEW |
| 9 | tradingSymbol | trading_symbol | trading_symbol | ✅ |
| 10 | securityId | security_id | security_id | ✅ |
| 11 | tradedQuantity | quantity | quantity | ✅ |
| 12 | tradedPrice | price | price | ✅ |
| 13 | createTime | created_at | created_at | ✅ |
| 14 | updateTime | updated_at | updated_at | ❌ NEW |
| 15 | exchangeTime | exchange_time | exchange_time | ❌ NEW |
| 16 | drvExpiryDate | drv_expiry_date | drv_expiry_date | ❌ NEW |
| 17 | drvOptionType | drv_option_type | drv_option_type | ❌ NEW |
| 18 | drvStrikePrice | drv_strike_price | drv_strike_price | ❌ NEW |

**New Fields Required**: 5 across model and schema

---

## Verification Checklist

After fixes:

- [ ] Trade model has all 18 fields
- [ ] Trade model to_dict() includes all 18 fields
- [ ] Database schema has all 18 columns
- [ ] Migration script adds missing columns
- [ ] save_trade() method saves all 18 fields
- [ ] get_trades_by_order_id() method exists
- [ ] get_trades() method exists with filters
- [ ] F&O fields properly validated (CALL/PUT CHECK constraint)
- [ ] Indexes created for performance (order_id, account_type+trade_ts, security_id)
- [ ] Documentation updated

---

## Conclusion

**Trade Book API Coverage**: ❌ **56% Incomplete**

### Current Status:
- ✅ API wrapper: 100% (both endpoints implemented)
- ❌ Trade model: 33% (6/18 fields)
- ⚠️ Database schema: 72% (13/18 columns)
- ❌ Database methods: 0% (no methods)

### Required Actions:
1. **Critical**: Add 9 missing fields to Trade model
2. **Critical**: Add 5 missing columns to trades table schema
3. **Critical**: Implement save_trade() and get_trades() database methods
4. **High**: Update migration script for backward compatibility
5. **Medium**: Update to_dict() method in Trade model
6. **Medium**: Add documentation for Trade Book support

**Priority**: HIGH - Trade data is critical for reconciliation and audit trails

**Reference**: https://dhanhq.co/docs/v2/orders/ (Trade Book section)

